---
// src/components/astro/ContactForm.astro
import { actions, isInputError } from 'astro:actions';
import { CircleCheck, Video, Sparkles } from '@lucide/astro';

// Obtener el resultado del form submission
const result = Astro.getActionResult(actions.sendContactEmail);

// ✅ PATRÓN PRG: Redirigir después de éxito para evitar reenvío
if (result && !result.error) {
  return Astro.redirect('/contacto?success=true');
}

// Verificar si venimos de un envío exitoso (después del redirect)
const showSuccess = Astro.url.searchParams.get('success') === 'true';

const zonas = [
  'Barrio de Salamanca',
  'Chamartín',
  'Pozuelo',
  'Majadahonda',
  'Las Rozas',
  'Retiro',
  'Boadilla del Monte',
  'Alcobendas',
  'Getafe',
  'Hortaleza',
  'Otra zona',
];

// Helper para obtener errores de campos
const getFieldError = (field: string): string | undefined => {
  if (result?.error && isInputError(result.error)) {
    return result.error.fields[field]?.[0];
  }
  return undefined;
};

// Generar timestamp del servidor para el formulario
const formTimestamp = Date.now().toString();
---

{showSuccess && (
  <div class="bg-green-50 border-2 border-green-200 rounded-2xl p-8 text-center mb-6">
    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <CircleCheck class="w-8 h-8 text-green-600" />
    </div>
    <h3 class="text-2xl font-bold text-slate-900 mb-2">
      ¡Mensaje enviado!
    </h3>
    <p class="text-slate-600 mb-6">
      Gracias por contactarnos. Te responderemos en menos de 24 horas.
    </p>
  </div>
)}

{!showSuccess && (
<form 
  method="POST" 
  action={actions.sendContactEmail} 
  class="space-y-6"
  id="contact-form"
>
  
  {/* <!-- Honeypot: campo trampa para bots --> */}
  <div class="absolute -left-[9999px] opacity-0 h-0 overflow-hidden" aria-hidden="true">
    <label for="website">Website (no rellenar)</label>
    <input 
      type="text" 
      id="website" 
      name="website" 
      tabindex="-1" 
      autocomplete="off"
    />
  </div>
  
  {/* <!-- Timestamp: para verificar tiempo mínimo de llenado --> */}
  <input type="hidden" name="_timestamp" id="_timestamp" value={formTimestamp} />


  <div>
    <label for="nombre" class="block text-sm font-semibold text-slate-700 mb-2">
      Nombre completo *
    </label>
    <input
      type="text"
      id="nombre"
      name="nombre"
      required
      maxlength="100"
      class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
      placeholder="Juan Pérez"
    />
    {getFieldError('nombre') && (
      <p class="text-red-600 text-sm mt-1">{getFieldError('nombre')}</p>
    )}
  </div>

  <div>
    <label for="empresa" class="block text-sm font-semibold text-slate-700 mb-2">
      Empresa *
    </label>
    <input
      type="text"
      id="empresa"
      name="empresa"
      required
      maxlength="150"
      class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
      placeholder="Reformas XYZ"
    />
    {getFieldError('empresa') && (
      <p class="text-red-600 text-sm mt-1">{getFieldError('empresa')}</p>
    )}
  </div>

  <div class="grid sm:grid-cols-2 gap-6">
    <div>
      <label for="email" class="block text-sm font-semibold text-slate-700 mb-2">
        Email *
      </label>
      <input
        type="email"
        id="email"
        name="email"
        required
        maxlength="254"
        class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
        placeholder="juan@empresa.com"
      />
      {getFieldError('email') && (
        <p class="text-red-600 text-sm mt-1">{getFieldError('email')}</p>
      )}
    </div>

    <div>
      <label for="telefono" class="block text-sm font-semibold text-slate-700 mb-2">
        Teléfono *
      </label>
      <input
        type="tel"
        id="telefono"
        name="telefono"
        required
        pattern="^(\+?34)?[\s\-]?[679]\d{2}[\s\-]?\d{3}[\s\-]?\d{3}$"
        class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
        placeholder="+34 600 000 000"
      />
      {getFieldError('telefono') && (
        <p class="text-red-600 text-sm mt-1">{getFieldError('telefono')}</p>
      )}
    </div>
  </div>

  <div>
    <label for="zona" class="block text-sm font-semibold text-slate-700 mb-2">
      Zona principal de operación *
    </label>
    <select
      id="zona"
      name="zona"
      required
      class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors bg-white"
    >
      <option value="">Selecciona una zona...</option>
      {zonas.map((zona) => (
        <option value={zona}>{zona}</option>
      ))}
    </select>
    {getFieldError('zona') && (
      <p class="text-red-600 text-sm mt-1">{getFieldError('zona')}</p>
    )}
  </div>

  <div>
    <label for="mensaje" class="block text-sm font-semibold text-slate-700 mb-2">
      Cuéntanos sobre tu empresa (opcional)
    </label>
    <textarea
      id="mensaje"
      name="mensaje"
      rows="4"
      maxlength="2000"
      class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors resize-none"
      placeholder="Ej: Somos una empresa familiar con 15 años de experiencia..."
    ></textarea>
    {getFieldError('mensaje') && (
      <p class="text-red-600 text-sm mt-1">{getFieldError('mensaje')}</p>
    )}
  </div>

  <!-- Privacidad -->
  <div class="flex items-start gap-3">
    <input
      type="checkbox"
      id="privacidad"
      name="privacidad"
      required
      class="mt-1 w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
    />
    <label for="privacidad" class="text-sm text-slate-600">
      Acepto la{' '}
      <a href="/privacidad" class="text-blue-600 hover:underline">
        política de privacidad
      </a>{' '}
      y el tratamiento de mis datos para recibir información comercial.
    </label>
  </div>

  {/* <!-- Error general --> */}
  {result?.error && !isInputError(result.error) && (
    <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 text-red-700 text-sm">
      {result.error.message || 'Ha ocurrido un error al enviar el formulario. Por favor, inténtalo de nuevo.'}
    </div>
  )}

  <button
    type="submit"
    class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all shadow-lg hover:shadow-xl text-lg disabled:opacity-50 disabled:cursor-not-allowed"
    id="submit-btn"
  >
    Solicitar Demo Gratuita
  </button>

  <div class="flex flex-wrap justify-center gap-6 text-sm text-slate-600">
    <div class="flex items-center gap-2">
      <CircleCheck class="w-4 h-4 text-green-600" />
      <span>Respuesta en menos de 24h</span>
    </div>
    <div class="flex items-center gap-2">
      <Video class="w-4 h-4 text-blue-600" />
      <span>Videollamada de 30 minutos</span>
    </div>
    <div class="flex items-center gap-2">
      <Sparkles class="w-4 h-4 text-yellow-600" />
      <span>Sin compromiso</span>
    </div>
  </div>
</form>
)}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('contact-form');
    const timestampInput = document.getElementById('_timestamp') as HTMLInputElement;
    
    if (form && timestampInput) {
      let timestampSet = false;
      
      form.addEventListener('focusin', () => {
        if (!timestampSet) {
          timestampInput.value = Date.now().toString();
          timestampSet = true;
        }
      }, { once: true });
    }

    // Deshabilitar botón mientras se envía
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const contactForm = document.getElementById('contact-form') as HTMLFormElement;
    
    if (contactForm && submitBtn) {
      contactForm.addEventListener('submit', () => {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';
      });
    }

    // Limpiar el parámetro success de la URL después de mostrar (opcional)
    if (window.location.search.includes('success=true')) {
      window.history.replaceState({}, '', window.location.pathname);
    }
  });
</script>

<style>
  [aria-hidden="true"] {
    position: absolute !important;
    left: -9999px !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
</style>